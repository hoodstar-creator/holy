<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ˆë§Œ ëª¨ë¥´ëŠ” ìš°ë¦¬ë“¤ì˜ ë¹„ë°€</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .achievement-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9); color: #fff;
            padding: 15px 40px; border-radius: 50px; border: 3px solid #ff69b4;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 9999;
            transition: top 0.5s ease-in-out;
        }
        .show-toast { top: 30px; }
        .toast-text span { font-weight: bold; font-size: 18px; }
        .character-img { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); filter: brightness(0.7); transform: scale(1); z-index: 1; }
        .character-img.speaking { filter: brightness(1.1) drop-shadow(0 0 10px rgba(255,105,180,0.5)); transform: scale(1.15); z-index: 10; }
    </style>
</head>
<body onload="userInteracted()">
    
    <audio id="bgm" loop>
        <source src="{{ url_for('static', filename='sound/bgm.mp3') }}" type="audio/mpeg">
    </audio>

    <audio id="sfxPlayer">
        <source src="" type="audio/mpeg">
    </audio>

    <div id="achToast" class="achievement-toast">
        <div style="font-size:30px;">ğŸ†</div>
        <div class="toast-text">
            <h4 style="margin:0; color:#ff69b4; font-size:14px;">ë„ì „ê³¼ì œ ë‹¬ì„±!</h4>
            <span id="achTitle">ì œëª©</span>
        </div>
    </div>

    <div class="doom-container">
        <div class="doom-label">â˜ ï¸ íŒŒêµ­ ê²Œì´ì§€ â˜ ï¸</div>
        <div class="doom-bar" id="doomBar" style="width: 0%;"></div>
    </div>

    <div class="game-container" id="gameScreen" style="background-image: url('{{ url_for('static', filename='images/bg_office.png') }}');">
        
        {% if current_char %}
        <div class="char-profile-card">
            <div class="profile-header"><span class="profile-icon">â™¬</span> SPEAKER INFO</div>
            <div class="profile-content">
                <div class="p-name">{{ current_char.name }}</div>
                <div class="p-desc">{{ current_char.desc }}</div>
            </div>
        </div>
        {% endif %}

        <div class="screen-area">
            {% for img_name in scene.images %}
                {% if img_name != 'bg_office.png' %}
                    {% set is_speaking = (speaker_key and speaker_key in img_name) %}
                    <img src="{{ url_for('static', filename='images/' + img_name) }}" 
                         class="character-img {{ 'speaking' if is_speaking else '' }}" 
                         alt="Character">
                {% endif %}
            {% endfor %}
        </div>

        <div class="ui-area">
            <div class="choice-container" id="choices" style="display: none;">
                {% for choice in scene.choices %}
                <a href="{{ url_for('action', next_scene=choice.next) }}" class="choice-btn">{{ choice.text }}</a>
                {% endfor %}
            </div>

            <div class="dialogue-box" onclick="skipTyping()">
                <div class="name-tag">{{ scene.speaker }}</div>
                <div class="text-content">
                    <span id="type-text"></span><span class="cursor">|</span>
                </div>
                <div class="menu-buttons">
                    <a href="{{ url_for('reset') }}">HOME</a>
                    <span>SAVE</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const bgm = document.getElementById("bgm");

        // --- ì´ˆê¸°í™” ë¡œì§ ---
        window.onload = function() {
            // 1. BGM ì²˜ë¦¬
            bgm.volume = 0.5;
            const savedTime = sessionStorage.getItem("bgm_time");
            if (savedTime) {
                bgm.currentTime = parseFloat(savedTime);
            }
            bgm.play().catch(e => console.log("Click to play"));

            // 2. í…ìŠ¤íŠ¸ íš¨ê³¼ (íƒ€ìê¸°)
            typeWriter(); 
            
            // 3. ë°ì´í„° ë¡œë“œ
            const achInfo = {{ achievement_info | tojson | safe }};
            const effectData = {{ effect_data | tojson | safe }};

            // 4. í™”ë©´ íš¨ê³¼ ì ìš©
            if (effectData) {
                if (effectData.doom !== undefined) {
                    document.getElementById('doomBar').style.width = effectData.doom + '%';
                }
                if (effectData.shake) {
                    const screen = document.getElementById('gameScreen');
                    screen.classList.add('shaking');
                    setTimeout(() => { screen.classList.remove('shaking'); }, 500);
                }
                if (effectData.sfx) {
                    playSfx(effectData.sfx);
                }
            }

            // 5. ë„ì „ê³¼ì œ ì²˜ë¦¬
            if (achInfo) {
                let savedData = {};
                try { savedData = JSON.parse(localStorage.getItem('secretGameAch')) || {}; } catch(e){}
                
                if (!savedData[achInfo.id]) {
                    savedData[achInfo.id] = true;
                    localStorage.setItem('secretGameAch', JSON.stringify(savedData));

                    const toast = document.getElementById('achToast');
                    document.getElementById('achTitle').innerText = achInfo.title;
                    toast.classList.add('show-toast');
                    setTimeout(() => { toast.classList.remove('show-toast'); }, 3000);
                }
            }
        };

        window.addEventListener("beforeunload", () => {
            sessionStorage.setItem("bgm_time", bgm.currentTime);
        });

        function userInteracted() {
            if (bgm.paused) { bgm.play(); }
        }

        // --- [í•µì‹¬ ìˆ˜ì •] HTML íƒœê·¸ ì§€ì› íƒ€ìê¸° íš¨ê³¼ ---
        // safe í•„í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ HTML íƒœê·¸ê°€ ê·¸ëŒ€ë¡œ ë“¤ì–´ì˜¤ë„ë¡ í•¨
        const fullText = `{{ scene.bg_text if scene.bg_text else scene.text | safe }}`;
        const typeElement = document.getElementById("type-text");
        const choiceContainer = document.getElementById("choices");
        let index = 0; let speed = 40; let isTyping = true;

        function typeWriter() {
            if (index < fullText.length) {
                let char = fullText.charAt(index);
                
                // ë§Œì•½ íƒœê·¸ì˜ ì‹œì‘(<)ì„ ë§Œë‚˜ë©´
                if (char === '<') {
                    let tag = "";
                    // ë‹«ëŠ” ê´„í˜¸(>)ê°€ ë‚˜ì˜¬ ë•Œê¹Œì§€ í•œë²ˆì— ì½ì–´ì„œ tag ë³€ìˆ˜ì— ì €ì¥
                    while (fullText.charAt(index) !== '>' && index < fullText.length) {
                        tag += fullText.charAt(index);
                        index++;
                    }
                    tag += '>'; // ë‹«ëŠ” ê´„í˜¸ ì¶”ê°€
                    index++;    // ì¸ë±ìŠ¤ ì¦ê°€
                    typeElement.innerHTML += tag; // íƒœê·¸ë¥¼ í†µì§¸ë¡œ ì¶”ê°€ (í™”ë©´ì—” ì•ˆ ë³´ì´ê³  íš¨ê³¼ë§Œ ì ìš©ë¨)
                    
                    // íƒœê·¸ë¥¼ ì¶”ê°€í–ˆìœ¼ë©´ ë”œë ˆì´ ì—†ì´ ë°”ë¡œ ë‹¤ìŒ ê¸€ì ì¶œë ¥ ì‹œë„
                    typeWriter(); 
                } else {
                    typeElement.innerHTML += char;
                    index++;
                    setTimeout(typeWriter, speed);
                }
            } else { 
                finishTyping(); 
            }
        }

        function finishTyping() {
            isTyping = false; typeElement.innerHTML = fullText;
            choiceContainer.style.display = "flex";
            document.querySelector('.cursor').style.display = 'none';
        }
        function skipTyping() {
            if (isTyping) { index = fullText.length; typeElement.innerHTML = fullText; finishTyping(); }
        }

        function playSfx(filename) {
            if (!filename || filename === 'None') return;
            var sfx = document.getElementById("sfxPlayer");
            sfx.src = "{{ url_for('static', filename='sound/') }}" + filename;
            sfx.volume = 0.8;
            sfx.play().catch(e => console.log("SFX error", e));
        }
    </script>
</body>
</html>